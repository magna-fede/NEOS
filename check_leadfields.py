#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Mon Apr  3 12:06:06 2023

@author: fm02
"""

import mne

import sys
import os
from os import path

import numpy as np
import pandas as pd

os.chdir("/home/fm02/MEG_NEOS/NEOS")
import NEOS_config as config

reject_criteria = config.epo_reject
flat_criteria = config.epo_flat

subjects_dir = config.subjects_dir

max_list = dict(eeg=[], mag=[], grad=[])
min_list = dict(eeg=[], mag=[], grad=[])
avg_list = dict(eeg=[], mag=[], grad=[])

def run_make_forward_solution(sbj_id):
    subject = str(sbj_id)
    
    print('Making Forward Solution for %s.' % subject)
   
    sbj_path = path.join(config.data_path, config.map_subjects[sbj_id][0])
    fwd_fname = path.join(sbj_path, subject + '_EEGMEG-fwd.fif')
    print('Making forward solution: %s.' % fwd_fname)

    fwd_eegmeg = mne.read_forward_solution(fwd_fname)
    
    mislab_ch = fwd_eegmeg['sol']['row_names']
    correct_ch = fwd_eegmeg['info']['ch_names']
    
    fwd_eegmeg['sol']['data'] = pd.DataFrame(fwd_eegmeg['sol']['data'], index=mislab_ch).loc[correct_ch, :].values
    fwd_eegmeg['sol']['row_names'] = correct_ch    
    leadfield = fwd_eegmeg['sol']['data']

    picks_eeg = mne.pick_types(fwd_eegmeg['info'], meg=False, eeg=True)
    picks_grad = mne.pick_types(fwd_eegmeg['info'], meg='grad', eeg=False)
    picks_mag = mne.pick_types(fwd_eegmeg['info'], meg='mag', eeg=False)
    
    for ch_type, picks in zip(['eeg', 'mag', 'grad'], [picks_eeg, picks_mag, picks_grad]):
        max_list[ch_type].append(leadfield[picks, :].max())
        min_list[ch_type].append(leadfield[picks, :].min())
        avg_list[ch_type].append(leadfield[picks, :].mean())

sbj_ids = [1,2,3,5,6,8,9,10,11,12,13,14,15,16,17,18,19,
           21,22,23,24,25,26,27,28,29,30]

[run_make_forward_solution(sbj_id) for sbj_id in sbj_ids]
    

# pd.DataFrame.from_dict(max_list)

#             eeg       mag      grad
# 0    928.872986  0.000023  0.001316
# 1    986.210693  0.000027  0.000778
# 2   1024.570435  0.000024  0.001227
# 3    799.462158  0.000017  0.000759
# 4    569.640625  0.000018  0.000667
# 5   1059.562622  0.000030  0.000895
# 6    980.163086  0.000021  0.000706
# 7    692.445007  0.000021  0.000651
# 8    851.624451  0.000023  0.001181
# 9   1048.814697  0.000027  0.000730
# 10   838.194031  0.000022  0.000794
# 11   725.092224  0.000019  0.001086
# 12   847.102600  0.000025  0.000817
# 13   985.472412  0.000026  0.000770
# 14   756.438232  0.000021  0.001014
# 15   842.924988  0.000021  0.000857
# 16   679.816467  0.000020  0.000821
# 17   645.116577  0.000020  0.001011
# 18   986.032776  0.000027  0.000906
# 19   645.235413  0.000019  0.000672
# 20  1090.352905  0.000020  0.000838
# 21  1136.796265  0.000018  0.000913
# 22   951.226196  0.000021  0.000916
# 23  1154.975342  0.000022  0.001100
# 24   864.458130  0.000017  0.000804
# 25   835.456299  0.000023  0.000780
# 26   782.278137  0.000017  0.000794

# min_leadfield
#             eeg       mag      grad
# 0  -1011.055847 -0.000026 -0.001465
# 1   -887.881775 -0.000023 -0.001544
# 2  -1055.602661 -0.000022 -0.001375
# 3   -784.474060 -0.000015 -0.000926
# 4   -587.606323 -0.000017 -0.001004
# 5  -1157.613403 -0.000024 -0.001813
# 6   -937.600891 -0.000020 -0.001290
# 7   -747.272949 -0.000018 -0.001223
# 8   -818.230408 -0.000023 -0.001377
# 9  -1086.378052 -0.000021 -0.001495
# 10  -781.986755 -0.000018 -0.001154
# 11  -761.475586 -0.000020 -0.001024
# 12  -856.877258 -0.000024 -0.001645
# 13  -820.691528 -0.000022 -0.001629
# 14  -700.094666 -0.000021 -0.001360
# 15  -838.636292 -0.000020 -0.001324
# 16  -572.162964 -0.000018 -0.001096
# 17  -693.104431 -0.000019 -0.001148
# 18 -1287.357910 -0.000021 -0.001515
# 19  -552.174133 -0.000017 -0.001021
# 20 -1104.572632 -0.000018 -0.001087
# 21 -1303.159302 -0.000016 -0.000824
# 22 -1485.268555 -0.000018 -0.001106
# 23 -1112.861206 -0.000019 -0.001032
# 24  -816.503479 -0.000017 -0.000858
# 25  -812.466858 -0.000022 -0.001486
# 26  -918.036438 -0.000017 -0.000893

# avg_leadfield
#           eeg           mag          grad
# 0    2.718900 -3.238744e-08 -8.531120e-08
# 1   11.968474 -2.341658e-08 -3.325101e-07
# 2    7.416783 -2.031113e-08 -2.763443e-07
# 3    3.494944 -2.562582e-08 -2.284750e-07
# 4    8.997586 -1.986191e-09 -5.272845e-07
# 5    8.088181 -2.048487e-08 -2.426536e-07
# 6   15.302145 -5.088763e-09 -4.834484e-07
# 7    5.940469 -1.763979e-08 -4.044393e-07
# 8    8.040315 -1.757226e-08 -4.429128e-07
# 9    2.980007 -2.707371e-08 -2.259843e-07
# 10   9.936082 -2.535539e-08 -2.999086e-07
# 11   2.081014 -3.477152e-08 -1.868718e-07
# 12   3.089230 -2.836594e-08 -2.134600e-07
# 13   7.855620 -1.314667e-08 -4.938317e-07
# 14   5.969660 -2.072326e-08 -3.287864e-07
# 15   1.418119 -3.219043e-08 -2.302443e-07
# 16   0.398835 -1.400325e-08 -4.235701e-07
# 17  10.117965 -2.108031e-09 -5.069990e-07
# 18   9.334285 -1.521243e-08 -2.677346e-07
# 19  10.809598 -1.268770e-08 -4.506483e-07
# 20   1.848128 -1.846372e-08 -2.565134e-07
# 21   6.046340 -1.383966e-08 -3.909149e-07
# 22   8.180867 -2.259629e-08 -2.953005e-07
# 23   7.878594 -1.608357e-08 -3.330175e-07
# 24  20.461199 -2.617933e-08 -1.954285e-07
# 25   0.754253 -1.229381e-08 -5.032998e-07
# 26  13.991190 -2.062214e-08 -2.707372e-07


